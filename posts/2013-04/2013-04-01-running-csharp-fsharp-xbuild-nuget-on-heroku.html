<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Running .Net on heroku</title>
    <link rel="stylesheet" href="/content/css/style.css" />
    <link rel="stylesheet" href="/content/css/tooltip.css" />
    <link rel="stylesheet" href="/content/css/tomorrow.css" />
    <link rel="stylesheet" href="/content/css/app.css" />
    <script type="text/javascript" src="/content/js/prettify.js"></script>
    <script type="text/javascript" src="/content/js/tooltip.js"></script>
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
    <script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script>
  </head>
  <body onload="prettyPrint()">
    <div id="container">
      <header><inner><h1><a style="padding-right: 50px;" href="/">&laquo;</a>Running .Net on heroku</h1></inner></header>
      <content>
<p></p>

<p>Recently I decided to try and get <a href="http://nancyfx.org/">Nancy</a> up and running on <a href="http://www.heroku.com/">Heroku</a>, heres a brief gist of things I did to get it up and working.</p>

<h2>The buildpack</h2>

<p>There are <a href="https://github.com/bvanderveen/heroku-mono-buildpack">a</a> <a href="https://github.com/brandur/heroku-buildpack-mono">few</a> <a href="https://github.com/BenHall/heroku-buildpack-mono">buildpacks</a> for mono2.x around on the internet but I was aiming for Mono 3 this turned out to be the longest part of the whole process.</p>

<p>I tried to use <a href="https://github.com/heroku/vulcan">vulcan</a> to create a buildpack but kept hitting issues so ended up <code>heroku run bash</code>'ing, building Mono 3 and netcat'ing it over, its available <a href="https://github.com/aktowns/mono3-buildpack">here</a>. I ended up throwing <a href="http://nuget.org/">Nuget</a> in there too. Heroku have some pretty good documentation on the process <a href="https://devcenter.heroku.com/articles/buildpack-api">here</a>. My compile script is pretty hacked together but seems to be holding up fine.</p>

<p>To use the build pack, pass it in with <code>heroku create</code> on a project</p>

<pre class='prettyprint  language-'>heroku create projname --buildpack https://github.com/aktowns/mono3-buildpack.git</pre>

<p>The buildpack looks for a solution file (.sln) in the root directory, and if it detects a packages.config it will run Nuget and attempt to install the packages to packages/ this syncs up with the way <a href="https://github.com/mrward/monodevelop-nuget-addin">monodevelop nuget addin</a> stores downloaded packages.</p>

<p><strong>The .gitignore file</strong></p>

<p>When committing files to the repo, I used the following .gitignore to not push up compiled binaries or packages as the buildpack should manage all of that.</p>

<pre class='prettyprint  language-'>projdir/bin
projdir/obj
packages/*
*.userprefs</pre>

<h2>Nancy</h2>

<p><a href="http://nancyfx.org/">Nancy</a> is a <a href="http://www.sinatrarb.com/">Sinatra</a> inspired framework for building web applications. Getting nancy setup with F# was pretty straight forward, the only issue initially was finding the right host to bind to, until i discovered binding to localhost allows connections intended for any host <em>(from the HTTP Host: header)</em>.</p>

<p>Make sure to include Nancy and Nancy.Hosting.Self using monodevelop-nuget-addin.</p>

<pre class="fssnip">
<span class="l"> 1: </span><span class="k">module</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c41', 1)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c41', 1)" class="i">viewfiles</span><span class="o">.</span><span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c42', 2)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c42', 2)" class="i">Main</span>
<span class="l"> 2: </span>
<span class="l"> 3: </span><span class="k">open</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c43', 3)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c43', 3)" class="i">System</span>
<span class="l"> 4: </span><span class="k">open</span> <span class="i">Nancy</span><span class="o">.</span><span class="i">Hosting</span>
<span class="l"> 5: </span>
<span class="l"> 6: </span><span class="k">type</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c44', 4)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c44', 4)" class="i">DemoApp</span> () <span class="o">=</span>
<span class="l"> 7: </span>    <span class="k">inherit</span> <span class="i">NancyModule</span>()
<span class="l"> 8: </span>    <span class="k">do</span>
<span class="l"> 9: </span>        <span class="k">let</span> <span class="i">Get</span> <span class="o">=</span> <span class="k">base</span><span class="o">.</span><span class="i">Get</span>
<span class="l">10: </span>        <span class="i">Get</span><span class="o">.</span>[<span class="s">&quot;</span><span class="s">/</span><span class="s">&quot;</span>] <span class="o">&lt;-</span> <span class="k">fun</span> <span class="i">parameters</span> <span class="k">-&gt;</span> <span class="s">&quot;</span><span class="s">Hello</span><span class="s"> </span><span class="s">from</span><span class="s"> </span><span class="s">F</span><span class="s">#</span><span class="s">/</span><span class="s">Nancy</span><span class="s"> </span><span class="s">on</span><span class="s"> </span><span class="s">Heroku</span><span class="s">!</span><span class="s">&quot;</span> <span class="o">:&gt;</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c45', 5)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c45', 5)" class="i">obj</span>
<span class="l">11: </span>
<span class="l">12: </span>[&lt;<span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c46', 6)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c46', 6)" class="i">EntryPoint</span>&gt;]
<span class="l">13: </span><span class="k">let</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c47', 7)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c47', 7)" class="i">main</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c48', 8)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c48', 8)" class="i">args</span> <span class="o">=</span> 
<span class="l">14: </span>    <span class="k">let</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c49', 9)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c49', 9)" class="i">env_port</span> <span class="o">=</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c410', 10)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c410', 10)" class="i">Environment</span><span class="o">.</span><span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c411', 11)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c411', 11)" class="i">GetEnvironmentVariable</span>(<span class="s">&quot;</span><span class="s">PORT</span><span class="s">&quot;</span>)
<span class="l">15: </span>    <span class="k">let</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c412', 12)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c412', 12)" class="i">port</span> <span class="o">=</span> <span class="k">if</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c49', 13)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c49', 13)" class="i">env_port</span> <span class="o">=</span> <span class="k">null</span> <span class="k">then</span> <span class="s">&quot;</span><span class="s">1234</span><span class="s">&quot;</span> <span class="k">else</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c49', 14)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c49', 14)" class="i">env_port</span>
<span class="l">16: </span>
<span class="l">17: </span>    <span class="k">let</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c413', 15)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c413', 15)" class="i">nancy_host</span> <span class="o">=</span> <span class="k">new</span> <span class="i">Nancy</span><span class="o">.</span><span class="i">Hosting</span><span class="o">.</span><span class="i">Self</span><span class="o">.</span><span class="i">NancyHost</span>(<span class="k">new</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c414', 16)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c414', 16)" class="i">Uri</span>(<span class="s">&quot;</span><span class="s">http</span><span class="s">:</span><span class="s">/</span><span class="s">/</span><span class="s">localhost</span><span class="s">:</span><span class="s">&quot;</span> <span class="o">+</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c412', 17)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c412', 17)" class="i">port</span>))
<span class="l">18: </span>    <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c413', 18)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c413', 18)" class="i">nancy_host</span><span class="o">.</span><span class="i">Start</span>()
<span class="l">19: </span>    <span class="k">while</span> <span class="k">true</span> <span class="k">do</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c415', 19)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c415', 19)" class="i">Console</span><span class="o">.</span><span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c416', 20)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c416', 20)" class="i">ReadLine</span>() <span class="o">|&gt;</span> <span onmouseout="hideTip(event, '63174b66-5426-49af-bd31-8393499db2c417', 21)" onmouseover="showTip(event, '63174b66-5426-49af-bd31-8393499db2c417', 21)" class="i">ignore</span>
<span class="l">20: </span>    <span class="n">0</span></pre>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c41">namespace viewfiles</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c42">module Main<br /><br />from viewfiles</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c43">namespace System</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c44">Multiple items<br />type DemoApp =<br />&#160;&#160;inherit obj<br />&#160;&#160;new : unit -&gt; DemoApp<br /><br />Full name: viewfiles.Main.DemoApp<br /><br />--------------------<br />new : unit -&gt; DemoApp</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c45">type obj = Object<br /><br />Full name: Microsoft.FSharp.Core.obj</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c46">Multiple items<br />type EntryPointAttribute =<br />&#160;&#160;inherit Attribute<br />&#160;&#160;new : unit -&gt; EntryPointAttribute<br /><br />Full name: Microsoft.FSharp.Core.EntryPointAttribute<br /><br />--------------------<br />new : unit -&gt; EntryPointAttribute</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c47">val main : args:string [] -&gt; int<br /><br />Full name: viewfiles.Main.main</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c48">val args : string []</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c49">val env_port : string</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c410">type Environment =<br />&#160;&#160;static member CommandLine : string<br />&#160;&#160;static member CurrentDirectory : string with get, set<br />&#160;&#160;static member Exit : exitCode:int -&gt; unit<br />&#160;&#160;static member ExitCode : int with get, set<br />&#160;&#160;static member ExpandEnvironmentVariables : name:string -&gt; string<br />&#160;&#160;static member FailFast : message:string -&gt; unit + 1 overload<br />&#160;&#160;static member GetCommandLineArgs : unit -&gt; string[]<br />&#160;&#160;static member GetEnvironmentVariable : variable:string -&gt; string + 1 overload<br />&#160;&#160;static member GetEnvironmentVariables : unit -&gt; IDictionary + 1 overload<br />&#160;&#160;static member GetFolderPath : folder:SpecialFolder -&gt; string + 1 overload<br />&#160;&#160;...<br />&#160;&#160;nested type SpecialFolder<br />&#160;&#160;nested type SpecialFolderOption<br /><br />Full name: System.Environment</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c411">Environment.GetEnvironmentVariable(variable: string) : string<br />Environment.GetEnvironmentVariable(variable: string, target: EnvironmentVariableTarget) : string</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c412">val port : string</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c413">val nancy_host : obj</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c414">Multiple items<br />type Uri =<br />&#160;&#160;new : uriString:string -&gt; Uri + 5 overloads<br />&#160;&#160;member AbsolutePath : string<br />&#160;&#160;member AbsoluteUri : string<br />&#160;&#160;member Authority : string<br />&#160;&#160;member DnsSafeHost : string<br />&#160;&#160;member Equals : comparand:obj -&gt; bool<br />&#160;&#160;member Fragment : string<br />&#160;&#160;member GetComponents : components:UriComponents * format:UriFormat -&gt; string<br />&#160;&#160;member GetHashCode : unit -&gt; int<br />&#160;&#160;member GetLeftPart : part:UriPartial -&gt; string<br />&#160;&#160;...<br /><br />Full name: System.Uri<br /><br />--------------------<br />Uri(uriString: string) : unit<br />Uri(uriString: string, uriKind: UriKind) : unit<br />Uri(baseUri: Uri, relativeUri: Uri) : unit<br />Uri(baseUri: Uri, relativeUri: string) : unit</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c415">type Console =<br />&#160;&#160;static member BackgroundColor : ConsoleColor with get, set<br />&#160;&#160;static member Beep : unit -&gt; unit + 1 overload<br />&#160;&#160;static member BufferHeight : int with get, set<br />&#160;&#160;static member BufferWidth : int with get, set<br />&#160;&#160;static member CapsLock : bool<br />&#160;&#160;static member Clear : unit -&gt; unit<br />&#160;&#160;static member CursorLeft : int with get, set<br />&#160;&#160;static member CursorSize : int with get, set<br />&#160;&#160;static member CursorTop : int with get, set<br />&#160;&#160;static member CursorVisible : bool with get, set<br />&#160;&#160;...<br /><br />Full name: System.Console</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c416">Console.ReadLine() : string</div>
<div class="tip" id="63174b66-5426-49af-bd31-8393499db2c417">val ignore : value:&#39;T -&gt; unit<br /><br />Full name: Microsoft.FSharp.Core.Operators.ignore</div>


<p><strong>The Procfile</strong></p>

<p>The procfile tells heroku how to launch your application, in the case of self-hosted nancy the following works fine with the buildpack above.</p>

<pre class='prettyprint  language-'>web: mono appdir/bin/Debug/app.exe</pre>

<h2>Compiling and deploying</h2>

<p>I had to enable build with xbuild in <a href="http://xamarin.com/studio">xamarin studio</a></p>

<p><img src="/content/images/Screen%20Shot%202013-04-01%20at%2010.30.26%20AM2.png" alt="xamarin studio" /></p>

<p>and edit the .fsproj to re-order the build order, so <code>Program.fs</code> sits last (or your file with the entrypoint)</p>

<p><img src="/content/images/Screen%20Shot%202013-04-01%20at%2010.40.25%20AM2.png" alt="re-order" /></p>

<p><code>git commit</code> your changes and push to heroku <code>git push heroku</code></p>

<p>This takes a while, as it needs to pull down the Mono environment from S3 (100mb), pull down Nuget and pull in Nugets dependencies im sure theres ways to speed this up with caching but have yet to try any of them out.</p>

<pre class='prettyprint  language-text'>Projects/viewfiles git:(master) ▶ git push heroku
Counting objects: 5, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 316 bytes, done.
Total 3 (delta 1), reused 0 (delta 0)

-----&gt; Fetching custom git buildpack... done
-----&gt; MonoFramework app detected
-----&gt; Copying mono to /tmp/build_1rpsx5dkzhkhv/vendor/
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  103M  100  103M    0     0  1746k      0  0:01:00  0:01:00 --:--:-- 2273k
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  235k  100  235k    0     0   262k      0 --:--:-- --:--:-- --:--:--  262k
-----&gt; Setting envvars
-----&gt; Importing trusted root certificates
Mozilla Roots Importer - version 3.0.7.0
Download and import trusted root certificates from Mozilla's MXR.
Copyright 2002, 2003 Motus Technologies. Copyright 2004-2008 Novell. BSD licensed.

Downloading from 'http://mxr.mozilla.org/seamonkey/source/security/nss/lib/ckfw/builtins/certdata.txt?raw=1'...
Importing certificates into user store...
140 new root certificates were added to your trust store.
Import process completed.

-----&gt; Setting up nuget
Checking for updates from https://nuget.org/api/v2/.
Currently running NuGet.exe 2.2.1.
NuGet.exe is up to date.
-----&gt; Installing dependencies with nuget
Successfully installed 'Nancy.Serialization.JsonNet 0.16.1'.
Successfully installed 'Nancy.Hosting.Self 0.16.1'.
Successfully installed 'Nancy.Authentication.Forms 0.16.1'.
Successfully installed 'Nancy.Viewengines.Razor 0.16.3'.
Successfully installed 'Nancy 0.16.1'.
Successfully installed 'System.Web.Razor.Unofficial 2.0.2'.
Successfully installed 'Newtonsoft.Json 4.5.11'.
-----&gt; Compiling application
XBuild Engine Version 3.0.7.0
Mono, Version 3.0.7.0
Copyright (C) Marek Sieradzki 2005-2008, Novell 2008-2011.

Build started 03/31/2013 21:53:10.
__________________________________________________
Project "/tmp/build_1rpsx5dkzhkhv/viewfiles.sln" (default target(s)):
  Target ValidateSolutionConfiguration:
    Building solution configuration "Debug|x86".
  Target Build:
    Project "/tmp/build_1rpsx5dkzhkhv/viewfiles/viewfiles.fsproj" (default target(s)):
      Target PrepareForBuild:
    ... SNIP ...
    Done building project "/tmp/build_1rpsx5dkzhkhv/viewfiles/viewfiles.fsproj".
Done building project "/tmp/build_1rpsx5dkzhkhv/viewfiles.sln".

Build succeeded.
   0 Warning(s)
   0 Error(s)

Time Elapsed 00:00:04.1524600
-----&gt; Discovering process types
       Procfile declares types -&gt; web

-----&gt; Compiled slug size: 110.5MB
-----&gt; Launching... done, v25
       http://viewfiles.herokuapp.com deployed to Heroku

To git@heroku.com:viewfiles.git
   dae558e..35cd50f  master -&gt; master</pre>

<p>All in all, im pretty impressed so far with the performance on heroku, mind you i'm really not doing anything intensive and really have a lot more to learn with Nancy.</p>

<p>Hope this helps wayward travellers, attempting to accomplish similar!</p>

<br /><br />
<center>
<g:plusone></g:plusone><a href="https://twitter.com/share" class="twitter-share-button" data-via="ikeeex" data-size="large">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<fb:like send="false" layout="button_count" width="200" show_faces="false"></fb:like>
</center>
<br />
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'randomblogs'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<a style="display: none" href="https://plus.google.com/114748638680077188435?rel=author">G+ Author linking</a>
</content>
      <footer>
        <inner>
          t:<a target="_blank" href="http://www.twitter.com/ikeeex">@ikeeex</a>
          g:<a target="_blank" href="http://www.github.com/aktowns">aktowns</a>
          <br />
          <br />
        </inner>
      </footer>
    </div>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-36036802-1']);
  _gaq.push(['_setDomainName', 'ashleytowns.id.au']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </body>
</html>
